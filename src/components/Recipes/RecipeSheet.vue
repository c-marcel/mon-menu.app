// Copyright ClÃ©ment MARCEL (NWANDA) 2022. All Rights Reserved.
// This file is licensed under the GNU Affero GPL v3.
// License text available at https://www.gnu.org/licenses/agpl-3.0.txt

// View for a recipe.
<script setup>
    import { ref, inject, watch } from 'vue'
    import axios from 'axios'

    import Months from '../Foods/FoodSheet/Months.vue'

    axios.defaults.withCredentials = true

    let recipeData  = ref(inject('recipeData'))
    let title       = ref('')
    let months      = ref([])
    let picture     = ref('')
    let content     = ref('')
    let nbOfParts   = ref(0)
    let ingredients = ref([])
    let type        = ref('')
    let temperature = ref('')
    let diet        = ref([])
    let prepTime    = ref(0)
    let cookTime    = ref(0)
    let restTime    = ref(0)
    let ingredCost  = ref(0)
    let energyCost  = ref(0)
    let energy      = ref(0)
    let water       = ref(0)
    let co2         = ref(0)

    let props = defineProps(['currentRecipeId'])

    function closeRecipe()
    {
        recipeData.value.currentRecipeId = ''
    }

    function loadIngredientData(ingredient)
    {
        // TODO: merge

        // Get food data.
        if (ingredient.hasOwnProperty('food'))
        {
            axios.get('https://api.mon-menu.app/getFoodData/' + ingredient.food)
            .then((response) =>
            {
                if (response.status == 200)
                {
                    let id = response.data.id

                    let d =
                    {
                        ingredient: ingredient,
                        data: response.data
                    }

                    ingredients.value.push(d)
                }
            }).catch(function(error)
            {
                // TODO
            });
        }

        // Get recipe data.
        else if (ingredient.hasOwnProperty('recipe'))
        {
            axios.get('https://api.mon-menu.app/getRecipeData/' + ingredient.recipe)
            .then((response) =>
            {
                if (response.status == 200)
                {
                    let id = response.data.id

                    let d =
                    {
                        ingredient: ingredient,
                        data: response.data
                    }

                    ingredients.value.push(d)
                }
            }).catch(function(error)
            {
                // TODO
            });
        }
    }

    function loadRecipeData(id)
    {
        axios.get('https://api.mon-menu.app/getRecipeData/' + id)
        .then((response) =>
        {
            if (response.status == 200)
            {
                title.value      = response.data.details
                months.value     = response.data.months
                content.value    = response.data.recipe
                nbOfParts.value  = response.data.nbOfParts
                prepTime.value   = response.data.times.preparation
                cookTime.value   = response.data.times.cooking
                restTime.value   = response.data.times.rest
                ingredCost.value = response.data.ingredientsCost
                water.value      = response.data.resources.water
                energy.value     = response.data.resources.energy.oven + response.data.resources.energy.hob

                // Set default picture if any.
                picture.value = response.data.picture
                if (picture.value == '')
                    picture.value = 'default.png'

                // Store ingredients and data (from Api).
                ingredients.value = []
                for (let i = 0 ; i < response.data.ingredients.length ; i++)
                {
                    loadIngredientData(response.data.ingredients[i])
                }

                // Recipe type.
                type.value = 'non dÃ©fini'
                if (response.data.type == 1)
                    type.value = 'apÃ©ritif'

                else if (response.data.type == 2)
                    type.value = 'entrÃ©e'

                else if (response.data.type == 4)
                    type.value = 'plat'

                else if (response.data.type == 8)
                    type.value = 'dessert'

                // Recipe temperature.
                temperature.value = 'non dÃ©finie'
                if (response.data.temperature == 0)
                    temperature.value = 'indiffÃ©rent'

                else if (response.data.temperature == 1)
                    temperature.value = 'froid'

                else if (response.data.temperature == 2)
                    temperature.value = 'chaud'

                console.log(temperature.value)

                // Diet.
                diet.value = []
                if (response.data.exclusions.meat && response.data.exclusions.fish)
                    diet.value.push('vegetarian')

                if (response.data.exclusions.meat && response.data.exclusions.fish
                    && response.data.exclusions.dairy && response.data.exclusions.eggs
                    && response.data.exclusions.oap)
                    diet.value.push('vegan')

                // Compute energy cost.
                // TODO: energy * costs from configuration
                energyCost.value = 0

                // Compute CO2.
                // TODO: add energy emissions with config.
                co2.value = response.data.environmentalImpact.ingredientsCo2eq 
            }
        })
        .catch(function(error)
        {
            // TODO
        });
    }

    // Watch props changes to update list.
    watch(props, (value) =>
    {
        if (value.currentRecipeId != '')
            loadRecipeData(value.currentRecipeId)
    })
</script>

<template>
    <!-- Blur background for the entire window -->
    <div v-show="currentRecipeId != ''" class="RecipeSheet_Cls">
        <!-- Solid background -->
        <div class="RecipeSheetBg_Cls">

            <!-- Header -->
            <div class="RecipeSheetHeader_Cls">
                <div class="RecipeSheetTitleMonths_Cls">
                    <div class="RecipeSheetTitle_Cls">
                        {{ title }}
                    </div>
                    <Months class="RecipeSheetMonths_Cls" :months="months">
                    </Months>
                </div>

                <!-- Close button -->
                <span class="RecipeSheetCloseButton_Cls" @click="closeRecipe()">Fermer</span>
            </div>

            <!-- Central container -->
            <div class="RecipeSheetCentralContainer_Cls">

                <!-- Left part with picture and ingredients -->
                <div class="RecipeSheetLeft_Cls">
                    <div class="RecipeSheetPhoto_Cls">
                        <img class="RecipeSheetPhotoImg_Cls" v-bind:src="'images/recipes/' + picture" />
                    </div>
                    <div class="RecipeSheetIngredients_Cls">
                        <div class="RecipeSheetNbOfParts_Cls">
                            Pour {{ nbOfParts }} parts :
                        </div>
                        <div class="RecipeSheetIngredientList_Cls">
                            <div class="RecipeSheetIngredientEntry_Cls" v-for="ingredient in ingredients" v-bind:key="ingredient.data.id">
                                <!-- Food/recipe picture -->
                                <div class="RecipeSheetIngredientPicture_Cls">ðŸ«’</div>

                                <!-- Food/recipe name and quantity -->
                                <div class="RecipeSheetIngredientTitleAndQuantity_Cls">
                                    <div class="RecipeSheetIngredientTitle_Cls">{{ ingredient.data.title }}</div>
                                    <div class="RecipeSheetIngredientQuantity_Cls">
                                        {{ ingredient.data.units != null ? $formatFloat(ingredient.ingredient.quantity * ingredient.data.units.conversion) + ' ' + ingredient.data.units.label : $formatFloat($formatWeight(ingredient.ingredient.quantity))}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right part with data and content -->
                <div class="RecipeSheetRight_Cls">
                    <div class="RecipeSheetData_Cls">
                        <!-- Recipe informations -->
                        <div class="RecipeSheetDataSlot_Cls">
                            <table>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">Type : </td>
                                    <td class="RecipeSheetDataValue_Cls">{{ type }}</td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">TempÃ©rature :</td>
                                    <td class="RecipeSheetDataValue_Cls">{{ temperature }}</td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">RÃ©gime :</td>
                                    <td class="RecipeSheetDataValue_Cls">
                                        <img v-if="diet.includes('vegan')" style="height: 20px;" src="images/vegan.png" title="VÃ©gÃ©talien" />
                                        <img v-if="diet.includes('vegetarian')" style="height: 20px; margin-left: 5px;" src="images/vegetarian.png" title="VÃ©gÃ©tarien" />
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- Times -->
                        <div class="RecipeSheetDataSlot_Cls">
                            <table>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">PrÃ©paration : </td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatTime(prepTime) }}</td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">Cuisson :</td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatTime(cookTime) }}</td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">Repos :</td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatTime(restTime) }}</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Costs -->
                        <div class="RecipeSheetDataSlot_Cls">
                            <table>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">CoÃ»t : </td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls RecipeSheetDataTitleAlignRight_Cls">ingrÃ©dients :</td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatFloat(ingredCost) + ' â‚¬'}}</td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls RecipeSheetDataTitleAlignRight_Cls">Ã©nergies :</td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatFloat(energyCost) + ' â‚¬' }}</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Environmental impacts -->
                        <div class="RecipeSheetDataSlot_Cls">
                            <table>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">Energie : </td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatFloat(energy) + ' kWh'}}</td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">Eau :</td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatFloat(water) + ' litres'}}</td>
                                </tr>
                                <tr>
                                    <td class="RecipeSheetDataTitle_Cls">Emissions CO<sub>2</sub> :</td>
                                    <td class="RecipeSheetDataValue_Cls">{{ $formatFloat(co2) + ' g' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="RecipeSheetContent_Cls">
                        {{ content }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<style scoped>
    .RecipeSheet_Cls
    {
        backdrop-filter:    blur(5px);
    }

    .RecipeSheetBg_Cls
    {
        position:           fixed;
        display:            flex;
        flex-direction:     column;
        top:                20px;
        bottom:             20px;
        left:               20px;
        right:              20px;
        background-color:   #9f5069;
        border:             solid 2px #c8b273;
        font-family:        'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    .RecipeSheetHeader_Cls
    {
        display:            flex;
    }

    .RecipeSheetTitleMonths_Cls
    {
        display:            flex;
        flex-direction:     column;
        flex-grow:          1;
        background-color:   #9f5069;
        user-select:        none;
    }

    .RecipeSheetCloseButton_Cls
    {
        height:             70px;
        width:              70px;
        line-height:        70px;
        text-align:         center;
        color:              #c8b273;
        background-color:   #834655;
    }

    .RecipeSheetCloseButton_Cls:hover
    {
        text-decoration:    underline;
        cursor:             pointer;
        user-select:        none;
    }

    .RecipeSheetCentralContainer_Cls
    {
        display:            flex;
        flex-grow:          1;
        overflow:           hidden;
    }

    .RecipeSheetLeft_Cls
    {
        display:            flex;
        flex-direction:     column;
        flex-grow:          1;
        min-width:          35%;
        max-width:          35%;
    }

    .RecipeSheetPhoto_Cls
    {
        flex-grow:          1;
        text-align:         center;
    }

    .RecipeSheetPhotoImg_Cls
    {
        width:              95%;
    }

    .RecipeSheetIngredients_Cls
    {
        flex-grow:          100;
        overflow:           hidden;
    }

    .RecipeSheetNbOfParts_Cls
    {
        text-align:         center;
        color:              #c8b273;
        font-size:          1.1em;
    }

    .RecipeSheetIngredientList_Cls
    {
        display:            flex;
        flex-direction:     column;
        gap:                10px;
        margin:             10px;
    }


    .RecipeSheetIngredientEntry_Cls
    {
        display:            flex;
        height:             40px;
        width:              40%;
        overflow:           hidden;
    }

    .RecipeSheetIngredientPicture_Cls
    {
        font-size:          2em;
        line-height:        40px;
    }

    .RecipeSheetIngredientTitleAndQuantity_Cls
    {
        display:            flex;
        flex-direction:     column;
        margin-left:        10px;
    }

    .RecipeSheetIngredientTitle_Cls
    {
        color:              #c8b273;
    }

    .RecipeSheetIngredientQuantity_Cls
    {
        font-style:         italic;
    }

    .RecipeSheetRight_Cls
    {
        display:            flex;
        flex-direction:     column;
        flex-grow:          1;
    }

    .RecipeSheetData_Cls
    {
        display:            flex;
        flex-grow:          1;
        gap:                20px;
    }

    .RecipeSheetDataSlot_Cls
    {
        width:              200px;
    }

    .RecipeSheetDataTitle_Cls
    {
        font-size:          0.9em;
        color:              #c8b273;
        min-width:          100px;
    }

    .RecipeSheetDataTitleAlignRight_Cls
    {
        text-align:         right;
    }

    .RecipeSheetDataValue_Cls
    {
        font-size:          0.9em;
        min-width:          100px;
    }

    .RecipeSheetContent_Cls
    {
        flex-grow:          1;
        padding:            10px;
        text-align:         justify;
        overflow:           auto;
        flex-grow:          100;
    }

    .RecipeSheetTitle_Cls
    {
        text-align:         center;
        padding-top:        10px;
        font-size:          1.2em;
        color:              #c8b273;
    }

    .RecipeSheetMonths_Cls
    {
        text-align:         center;
        margin-top:         5px;
    }
</style>
